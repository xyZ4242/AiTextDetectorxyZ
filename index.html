<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" 
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>AI Text Detector â€” Pro v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<style>
  /* === VARIABLES === */
  :root{
    --bg: #05090c;
    --card-bg: rgba(20, 27, 34, 0.7);
    --text-main: #eef2f6;
    --text-muted: #8b9bb4;
    --primary: #3b82f6;
    --primary-glow: rgba(59, 130, 246, 0.4);
    --accent: #10b981; --danger: #f43f5e; --warning: #f59e0b;
    --border: rgba(255,255,255,0.08);
    --glass: rgba(255,255,255,0.02);
    --ig-color: #E1306C;
  }

  * { box-sizing: border-box; outline: none; }
  
  html { scroll-behavior: smooth; }

  body {
    margin: 0;
    background-color: var(--bg);
    background-image: 
      radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.08), transparent 25%), 
      radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05), transparent 25%);
    color: var(--text-main);
    font-family: 'Plus Jakarta Sans', sans-serif;
    min-height: 100vh;
    display: flex; flex-direction: column;
    overflow-x: hidden;
  }

  /* === LAYOUT === */
  .wrap {
    max-width: 1000px; margin: 40px auto; padding: 0 24px; width: 100%;
    animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; flex-direction: column; min-height: 90vh;
  }

  h1, h2, h3, .val, .logo { font-family: 'Outfit', sans-serif; }

  header {
    display: flex; align-items: center; gap: 20px;
    margin-bottom: 32px; padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  /* === LOGO === */
  .logo {
    width: 56px; height: 56px; min-width: 56px; flex-shrink: 0;
    border-radius: 16px; background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 20px var(--primary-glow);
    position: relative; overflow: hidden;
  }
  .logo svg { animation: slightRotate 10s infinite linear; }
  .pulse-dot { animation: brainPulse 2s infinite ease-in-out; transform-origin: center; }

  /* === GRID SYSTEM === */
  .grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
    flex-grow: 1;
  }

  .card {
    background: var(--card-bg);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border); border-radius: 20px; padding: 24px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    display: flex; flex-direction: column;
    transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  /* === TABS === */
  .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .tab-btn {
    background: transparent; color: var(--text-muted); border: 1px solid transparent;
    padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .tab-btn:hover { color: var(--text-main); background: var(--glass); }
  .tab-btn.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); border-color: rgba(59, 130, 246, 0.2); font-weight: 600; }
  
  .input-panel { display: none; animation: fadeIn 0.3s ease; margin-bottom: 16px; }
  .input-panel.active { display: block; }

  /* === FILE UPLOAD UI === */
  .drop-zone {
    border: 2px dashed var(--border); border-radius: 12px; padding: 32px;
    text-align: center; cursor: pointer; transition: all 0.3s; background: var(--glass);
  }
  .drop-zone:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
  .drop-zone p { margin: 8px 0 0; color: var(--text-muted); font-size: 13px; }
  #fileInput { display: none; }

  /* === URL INPUT UI === */
  .url-group { display: flex; gap: 10px; }
  .url-input {
    flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
    padding: 12px 16px; border-radius: 10px; color: var(--text-main); font-family: inherit;
  }
  .url-input:focus { border-color: var(--primary); }
  
  /* === TEXT AREA === */
  .input-wrapper { position: relative; overflow: hidden; border-radius: 12px; }
  textarea {
    width: 100%; min-height: 320px;
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--border); border-radius: 12px; padding: 16px;
    color: inherit; font-family: 'Plus Jakarta Sans', monospace;
    font-size: 15px; line-height: 1.6; resize: vertical;
    transition: all 0.3s ease; display: block;
  }
  textarea:focus {
    border-color: var(--primary); background: rgba(0,0,0,0.3);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  .loading-overlay {
    position: absolute; top:0; left:0; width: 100%; height: 100%;
    background: rgba(5, 9, 12, 0.8); backdrop-filter: blur(4px);
    display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
  }
  .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;}

  /* Laser Scan Effect */
  .scan-line {
    position: absolute; top: 0; left: 0; width: 100%; height: 4px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    box-shadow: 0 0 15px var(--primary);
    opacity: 0; pointer-events: none; z-index: 5;
  }
  .scanning .scan-line { animation: scanMove 1.5s cubic-bezier(0.45, 0, 0.55, 1) forwards; opacity: 1; }
  
  @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* === BUTTONS === */
  .controls { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  button {
    border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer;
    font-weight: 600; font-size: 14px; font-family: 'Outfit', sans-serif;
    transition: transform 0.1s, box-shadow 0.2s;
  }
  button:active { transform: scale(0.96); }

  #analyzeBtn, #fetchUrlBtn {
    background: linear-gradient(135deg, var(--primary), #2563eb);
    color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }
  #analyzeBtn { flex-grow: 1; max-width: 220px; }
  #analyzeBtn:hover, #fetchUrlBtn:hover { box-shadow: 0 8px 24px rgba(37, 99, 235, 0.5); transform: translateY(-2px); }
  
  .btn-sec { background: rgba(255,255,255,0.05); color: var(--text-muted); }
  .btn-sec:hover { background: rgba(255,255,255,0.1); color: white; }

  /* === RESULT PANEL === */
  .result-side {
    opacity: 0.4; filter: blur(4px); transform: translateY(20px);
    pointer-events: none; transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  
  .result-side.active {
    opacity: 1; filter: blur(0); transform: translateY(0);
    pointer-events: auto; border-color: rgba(59, 130, 246, 0.3);
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  }

  .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .badge { font-size: 12px; font-weight: 700; padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-muted); }

  /* Gauge & Stats */
  .meter-wrap { display: flex; justify-content: center; margin-bottom: 24px; }
  .gauge-ring {
    width: 180px; height: 180px; border-radius: 50%;
    background: conic-gradient(var(--primary) 0deg, rgba(255,255,255,0.05) 0deg);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 40px rgba(0,0,0,0.3); transition: background 1s ease;
  }
  .gauge-inner { width: 150px; height: 150px; background: #0f151a; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .val { font-size: 36px; font-weight: 700; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  .breakdown { display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
  .track { height: 6px; width: 100%; background: rgba(255,255,255,0.06); border-radius: 10px; overflow: hidden; }
  .fill { height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 10px; transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
  
  .stat-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }

  .meta-info { display: flex; justify-content: center; gap: 24px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin: 20px 0; font-size: 13px; color: var(--text-muted); border: 1px solid var(--border); }
  
  .explanation-box { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
  
  select#lang { background: var(--glass); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 12px; border-radius: 8px; cursor: pointer; }

  /* === FOOTER CREDIT STYLES === */
  .page-footer {
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 12px;
    color: var(--text-muted); font-size: 13px;
  }
  
  .credit-link {
    display: inline-flex; align-items: center; gap: 8px;
    text-decoration: none; color: var(--text-main);
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    padding: 8px 16px; border-radius: 50px;
    font-weight: 600; transition: all 0.3s ease;
  }
  
  .credit-link svg { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
  
  .credit-link:hover {
    background: rgba(225, 48, 108, 0.1);
    border-color: var(--ig-color);
    color: var(--ig-color);
    box-shadow: 0 0 20px rgba(225, 48, 108, 0.2);
    transform: translateY(-2px);
  }
  
  .credit-link:hover svg { transform: scale(1.2) rotate(-5deg); }

  @keyframes brainPulse { 0%, 100% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
  @keyframes slightRotate { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(3deg); } 75% { transform: rotate(-3deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Responsive */
  @media(max-width: 900px){
    .grid { grid-template-columns: 1fr; gap: 32px; }
  }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="logo">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2V4" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 20V22" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M20 12H22" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M2 12H4" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17Z" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="12" r="2" fill="white" class="pulse-dot"/>
        <path d="M17 12H15" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 12H9" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M15.5 15.5L14 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M8.5 8.5L10 10" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <div style="flex-grow:1">
      <h1>AI Text Detector</h1>
      <p class="lead" style="font-size:14px;color:var(--text-muted)">Supports: Text, PDF, Docx, TXT, URL</p>
    </div>
    <div>
      <select id="lang"><option value="id">ðŸ‡®ðŸ‡© ID</option><option value="en">ðŸ‡ºðŸ‡¸ EN</option></select>
    </div>
  </header>

  <div class="grid">
    <div class="card" style="z-index: 2;">
      
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('text')">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Paste Text
        </button>
        <button class="tab-btn" onclick="switchTab('file')">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
          Upload File
        </button>
        <button class="tab-btn" onclick="switchTab('url')">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          Web Link
        </button>
      </div>

      <div id="panel-file" class="input-panel">
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
          <svg width="40" height="40" stroke="var(--primary)" fill="none" stroke-width="1.5" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          <p>Klik untuk upload <b>PDF, DOCX, TXT</b></p>
          <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.doc">
        </div>
      </div>

      <div id="panel-url" class="input-panel">
        <div class="url-group">
          <input type="text" class="url-input" id="urlInput" placeholder="https://example.com/artikel">
          <button id="fetchUrlBtn" onclick="fetchUrl()">Fetch</button>
        </div>
        <p style="font-size:11px;color:var(--text-muted);margin-top:8px">Note: Menggunakan proxy publik. Mungkin lambat.</p>
      </div>

      <div style="display:flex;justify-content:space-between;margin-bottom:8px;margin-top:8px">
        <label style="font-weight:600;color:var(--text-main);font-size:13px" id="lblInput">Konten Teks</label>
      </div>
      
      <div class="input-wrapper" id="inputWrapper">
        <div class="scan-line"></div>
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
          <span style="font-size:12px;color:var(--text-muted)">Processing...</span>
        </div>
        <textarea id="inputText" placeholder="Tempel teks atau hasil upload akan muncul di sini..."></textarea>
      </div>

      <div class="controls">
        <button id="analyzeBtn">Analyze Text</button>
        <button id="clearBtn" class="btn-sec">Clear</button>
        <div class="hint" id="hintNote">Min ~50 kata</div>
      </div>
    </div>

    <div class="card result-side" id="resultCard">
      <div class="result-header">
        <div style="font-weight:600" id="lblResult">Hasil Deteksi</div>
        <div class="badge" id="label">WAITING</div>
      </div>

      <div class="meter-wrap">
        <div class="gauge-ring" id="gauge">
          <div class="gauge-inner">
            <div class="lbl-score" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)" id="lblAILikelihood">AI PROBABILITY</div>
            <div class="val" id="percent">0%</div>
          </div>
        </div>
      </div>

      <div class="meta-info">
        <span><b id="valWords">0</b> <span id="txtWords">Kata</span></span>
        <span style="width:1px;background:var(--border)"></span>
        <span><b id="valSent">0</b> <span id="txtSent">Kalimat</span></span>
      </div>

      <div class="breakdown">
        <div>
          <div class="stat-label"><span id="lblRep">Repetisi</span> <span id="valRep">0%</span></div>
          <div class="track"><div class="fill" id="barRepetition"></div></div>
        </div>
        <div>
          <div class="stat-label"><span id="lblVar">Variasi Kalimat</span> <span id="valVar">0%</span></div>
          <div class="track"><div class="fill" id="barSentVar"></div></div>
        </div>
        <div>
          <div class="stat-label"><span id="lblTTR">Kosakata Unik</span> <span id="valTTR">0%</span></div>
          <div class="track"><div class="fill" id="barTTR"></div></div>
        </div>
        <div>
          <div class="stat-label"><span id="lblPunct">Tanda Baca</span> <span id="valPunct">0%</span></div>
          <div class="track"><div class="fill" id="barPunct"></div></div>
        </div>
        <div>
          <div class="stat-label"><span id="lblEntropy">Entropi (Kompleksitas)</span> <span id="valEntropy">0%</span></div>
          <div class="track"><div class="fill" id="barEntropy"></div></div>
        </div>
      </div>

      <div class="explanation-box">
        <div class="explain-text" id="explainText" style="font-size:13px;color:var(--text-muted)">Menunggu input untuk dianalisis...</div>
      </div>
    </div>
  </div>

  <div class="page-footer">
    <span>Developed by</span>
    <a href="https://instagram.com/savero_aja" target="_blank" class="credit-link">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C14.717 2 15.056 2.01 16.122 2.06C17.187 2.11 17.912 2.277 18.55 2.525C19.21 2.779 19.766 3.123 20.322 3.678C20.878 4.234 21.222 4.79 21.475 5.45C21.722 6.087 21.89 6.813 21.94 7.878C21.988 8.944 22 9.283 22 12C22 14.717 21.99 15.056 21.94 16.122C21.89 17.187 21.722 17.912 21.475 18.55C21.222 19.21 20.878 19.766 20.322 20.322C19.766 20.878 19.21 21.222 18.55 21.475C17.912 21.722 17.187 21.89 16.122 21.94C15.056 21.99 14.717 22 12 22C9.283 22 8.944 21.99 7.878 21.94C6.813 21.89 6.087 21.722 5.45 21.475C4.79 21.222 4.234 20.878 3.678 20.322C3.123 19.766 2.779 19.21 2.525 18.55C2.277 17.912 2.11 17.187 2.06 16.122C2.01 15.056 2 14.717 2 12C2 9.283 2.01 8.944 2.06 7.878C2.11 6.813 2.277 6.087 2.525 5.45C2.779 4.79 3.123 4.234 3.678 3.678C4.234 3.123 4.79 2.779 5.45 2.525C6.087 2.277 6.813 2.11 7.878 2.06C8.944 2.01 9.283 2 12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 7C9.239 7 7 9.239 7 12C7 14.761 9.239 17 12 17C14.761 17 17 14.761 17 12C17 9.239 14.761 7 12 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M17.5 6.5H17.51" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      @savero
    </a>
  </div>
</div>

<script>
/* === CONFIG & UTILS === */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const els = {
  input: document.getElementById("inputText"), inputWrap: document.getElementById("inputWrapper"),
  loading: document.getElementById("loadingOverlay"),
  lang: document.getElementById("lang"), percent: document.getElementById("percent"),
  gauge: document.getElementById("gauge"), label: document.getElementById("label"),
  resultCard: document.getElementById("resultCard"),
  analyzeBtn: document.getElementById("analyzeBtn"),
  tabs: document.querySelectorAll('.tab-btn'),
  panels: { text: null, file: document.getElementById("panel-file"), url: document.getElementById("panel-url") },
  bars: { rep: document.getElementById("barRepetition"), var: document.getElementById("barSentVar"), ttr: document.getElementById("barTTR"), punct: document.getElementById("barPunct"), entropy: document.getElementById("barEntropy") },
  vals: { rep: document.getElementById("valRep"), var: document.getElementById("valVar"), ttr: document.getElementById("valTTR"), punct: document.getElementById("valPunct"), entropy: document.getElementById("valEntropy") },
  explain: document.getElementById("explainText"), meta: { w: document.getElementById("valWords"), s: document.getElementById("valSent") }
};

/* === TAB SWITCHER === */
function switchTab(mode){
  els.tabs.forEach(t => t.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  els.panels.file.classList.remove('active');
  els.panels.url.classList.remove('active');
  
  if(mode === 'file') els.panels.file.classList.add('active');
  if(mode === 'url') els.panels.url.classList.add('active');
}

/* === FILE HANDLING === */
document.getElementById('fileInput').addEventListener('change', async function(e){
  const file = e.target.files[0];
  if(!file) return;

  showLoading(true);
  
  try {
    let text = "";
    const ext = file.name.split('.').pop().toLowerCase();

    if(ext === 'txt'){
      text = await file.text();
    } else if (ext === 'pdf'){
      text = await readPdf(file);
    } else if (ext === 'docx' || ext === 'doc'){
      text = await readDocx(file);
    } else {
      alert("Format tidak didukung.");
    }
    
    els.input.value = text;
    switchTab('text'); 
  } catch(err) {
    console.error(err);
    alert("Gagal membaca file: " + err.message);
  }
  showLoading(false);
});

async function readPdf(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  let fullText = "";
  
  for(let i=1; i<=pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    const pageText = textContent.items.map(item => item.str).join(' ');
    fullText += pageText + "\n";
  }
  return fullText;
}

async function readDocx(file){
  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
  return result.value;
}

/* === URL SCRAPING (VIA PROXY) === */
async function fetchUrl(){
  const url = document.getElementById('urlInput').value;
  if(!url) return;
  
  showLoading(true);
  try {
    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
    const data = await res.json();
    
    if(data.contents){
      const parser = new DOMParser();
      const doc = parser.parseFromString(data.contents, 'text/html');
      ['script', 'style', 'nav', 'footer', 'header', 'iframe'].forEach(tag => {
        const elements = doc.querySelectorAll(tag);
        elements.forEach(el => el.remove());
      });
      els.input.value = doc.body.innerText.replace(/\s+/g, ' ').trim();
    } else {
      alert("Gagal mengambil konten URL.");
    }
  } catch(e){
    alert("Error fetching URL (CORS/Network).");
  }
  showLoading(false);
}

function showLoading(isLoading){
  els.loading.style.display = isLoading ? 'flex' : 'none';
}

/* === LOGIC ANALISIS === */
function tokenizeWords(text){ return text.replace(/[\n\r]+/g,' ').split(/\s+/).filter(Boolean).map(w=>w.replace(/^[^a-zA-Z0-9']+|[^a-zA-Z0-9']+$/g,'').toLowerCase()); }
function sentences(text){ return text.split(/([.?!]|(?<!\.)\.\.\.(?!\.))\s+/g).filter((_, i) => i % 2 === 0).map(s=>s.trim()).filter(Boolean); }
function charEntropy(s){ if (s.length === 0) return 0; const freq = {}; for (const c of s.toLowerCase().replace(/\s/g, '')) freq[c]=(freq[c]||0)+1; const n = Object.values(freq).reduce((a,b)=>a+b,0); let H = 0; for (const k in freq){ const p = freq[k]/n; H -= p * Math.log2(p); } return H; }
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
function sd(arr){ if(arr.length <= 1) return 0; const m=mean(arr); return Math.sqrt(mean(arr.map(x=>Math.pow(x-m,2)))); }
function clamp01(x){ return Math.max(0,Math.min(1,x)); }

function analyzeText(text){
  const raw = text.trim(); const sent = sentences(raw); const words = tokenizeWords(raw); const wcount = words.length;
  const comp = { 
    scRepetition: clamp01(1 - ((Object.values(words.reduce((a,w)=>{a[w]=(a[w]||0)+1;return a},{})).filter(c=>c>1).length / words.length) - 0.04) / (0.20 - 0.04)), 
    scTTR: wcount===0?0:clamp01(1 - ((new Set(words).size / words.length) - 0.38) / (0.60 - 0.38)), 
    scSentVar: clamp01(1 - (sd(sent.map(s=>s.split(/\s+/).filter(Boolean).length)) - 1.5) / (15.0 - 1.5)), 
    scPunct: wcount===0?0:clamp01((( (text.match(/[,\.;:!?]/g)||[]).length / words.length) - 0.01) / (0.05 - 0.01)), 
    scEntropy: clamp01(1 - (charEntropy(raw) - 4.2) / (4.8 - 4.2)), 
    wcount 
  };
  const weights = { rep:0.10, ttr:0.25, sentVar:0.30, punct:0.10, entropy:0.25 };
  let rawScore = (comp.scRepetition*weights.rep + comp.scTTR*weights.ttr + comp.scSentVar*weights.sentVar + comp.scPunct*weights.punct + comp.scEntropy*weights.entropy) / 1.0;
  if (wcount < 50){ const f = (50 - wcount)/50; rawScore = rawScore*(1-f) + 0.5*f; }
  const finalScore = rawScore < 0.4 || rawScore > 0.9 ? rawScore : clamp01(rawScore + (1 - rawScore) * 0.20 * rawScore);
  return {score: finalScore, components: comp};
}

function updateUI(score, comp, text){
  const pct = Math.round(score*100);
  animateValue(els.percent, 0, pct, 1000);
  
  let color = pct >= 80 ? 'var(--danger)' : (pct >= 55 ? 'var(--warning)' : 'var(--accent)');
  els.gauge.style.background = `conic-gradient(${color} ${Math.round(pct*3.6)}deg, rgba(255,255,255,0.05) 0deg)`;
  
  const L = els.lang.value === 'id' ? 
    {ai:"DOMINAN AI", mix:"MUNGKIN AI", hu:"INDIKASI MANUSIA", exAI:"Pola teks sangat seragam.", exHu:"Struktur organik & variatif."} : 
    {ai:"LIKELY AI", mix:"POSSIBLY AI", hu:"LIKELY HUMAN", exAI:"Highly uniform patterns.", exHu:"Organic structure."};

  if (pct >= 80) { els.label.textContent = L.ai; els.label.style.color = 'var(--danger)'; els.label.style.borderColor='var(--danger)'; }
  else if (pct >= 55){ els.label.textContent = L.mix; els.label.style.color = 'var(--warning)'; els.label.style.borderColor='var(--warning)';}
  else { els.label.textContent = L.hu; els.label.style.color = 'var(--accent)'; els.label.style.borderColor='var(--accent)';}

  els.meta.w.textContent = comp.wcount; els.meta.s.textContent = sentences(text).length;

  const setBar = (key, val) => {
    const v = Math.round(val*100);
    els.bars[key].style.width = v + "%"; els.vals[key].textContent = v + "%";
    els.bars[key].style.background = v > 70 ? 'var(--danger)' : (v > 40 ? 'var(--warning)' : 'linear-gradient(90deg, #3b82f6, #8b5cf6)');
  };
  setBar('rep', comp.scRepetition); setBar('var', comp.scSentVar); setBar('ttr', comp.scTTR); setBar('punct', comp.scPunct); setBar('entropy', comp.scEntropy);
  
  els.explain.innerHTML = `<strong style="color:${color}">${pct > 60 ? L.exAI : L.exHu}</strong><br>Score ${pct}%`;
}

function animateValue(obj, start, end, duration) {
  let startTimestamp = null;
  const step = (timestamp) => {
    if (!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    obj.innerHTML = Math.floor(progress * (end - start) + start) + "%";
    if (progress < 1) window.requestAnimationFrame(step);
  };
  window.requestAnimationFrame(step);
}

document.getElementById("analyzeBtn").onclick = ()=>{
  const txt = els.input.value;
  if(!txt.trim() || sentences(txt).length < 2) { alert("Minimal 2 kalimat / ~50 kata."); return; }

  els.inputWrap.classList.add('scanning');
  els.analyzeBtn.textContent = "Scanning...";
  els.analyzeBtn.disabled = true;
  els.resultCard.classList.remove('active');

  setTimeout(()=>{
    els.inputWrap.classList.remove('scanning');
    const {score, components} = analyzeText(txt);
    updateUI(score, components, txt);
    els.analyzeBtn.textContent = "Analyze Text";
    els.analyzeBtn.disabled = false;
    els.resultCard.classList.add('active');
    if(window.innerWidth < 900) els.resultCard.scrollIntoView({behavior: "smooth", block: "start"});
  }, 1200);
};

document.getElementById("clearBtn").onclick = ()=>{
  els.input.value = "";
  els.resultCard.classList.remove('active');
};
</script>
</body>
</html>
